- name: update apt-get repo and cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: install a list dependencies for Foxpass
  apt: 
    pkg:
    - curl
    - libnss-ldapd
    - nscd
    - nslcd

- name: write foxpass_ssh_keys.sh 
  template: 
    src: foxpass_ssh_keys.sh.j2
    dest: /usr/local/sbin/foxpass_ssh_key.sh

- name: write nslcd.conf 
  template:
    src: nslcd.conf.j2
    dest: /etc/nslcd.conf
    mode: '0640'
  notify:
    - restart nslcd

- name: check sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '#auto-generated by Foxpass'
    state: absent 
  check_mode: yes
  changed_when: False
  register: ssh_config_regex

- name: augment sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "#auto-generated by Foxpass\nAuthorizedKeysCommand\t\t/usr/local/sbin/foxpass_ssh_keys.sh\nAuthorizedKeysCommandUser\troot\n"
  when: not ssh_config_regex.found
  notify: restart ssh

- name: check pam
  lineinfile:
    path: /etc/pam.d/common-session
    line: "#auto-generated by Foxpass"
    state: absent 
  check_mode: yes
  changed_when: False
  register: pam_regex
    
- name: augment pam
  lineinfile:
    path: /etc/pam.d/common-session
    line: "#auto-generated by Foxpass\nsession required\tpam_mkhomedir.so umask=0022 skel=/etc/skel\n"
  when: not pam_regex.found
  notify: 
    - restart nslcd
    - restart nscd

- name: check pam noninteractive
  lineinfile:
    path: /etc/pam.d/common-session-noninteractive
    line: "#auto-generated by Foxpass"
    state: absent 
  check_mode: yes
  changed_when: False
  register: pam_noninteractive_regex

- name: augment pam noninteractive
  lineinfile:
    path: /etc/pam.d/common-session-noninteractive
    line: "#auto-generated by Foxpass\nsession required\tpam_mkhomedir.so umask=0022 skel=/etc/skel\n"
  when: not pam_noninteractive_regex.found
  notify:
    - restart nslcd
    - restart nscd

- name: check sudoers
  lineinfile:
    path: /etc/sudoers
    line: "#auto-generated by Foxpass"
    state: absent 
  check_mode: yes
  changed_when: False
  register: sudoers_regex

- name: augment /etc/sudoers
  lineinfile:
    path: /etc/sudoers
    line: "#auto-generated by Foxpass\n#includedir /etc/sudoers.d\n"
  when: not sudoers_regex.found

- name: create sudoers.d directory
  file:
    path: /etc/sudoers.d
    state: directory
    mode: '0750'

- name: place sudoers.d file template
  template: 
    src: 95-foxpass-sudo.j2
    dest: /etc/sudoers.d/95-foxpass-sudo

- name: update sudoers file when not require pw
  lineinfile:
    path: /etc/sudoers
    regex: "^%sudo ALL=(ALL:ALL) ALL"
    line: "%sudo ALL=(ALL:ALL) NOPASSWD:ALL"
    backrefs: yes
  when: require_sudoers_pw

- name: check eic
  stat: 
    path: /lib/systemd/system/ssh.service.d/ec2-instance-connect.conf
  register: eic_stat

- name: fix eic
  file:
    src: /lib/systemd/system/ssh.service.d/ec2-instance-connect.conf
    dest: /lib/systemd/system/ssh.service.d/ec2-instance-connect.conf.disabled
    state: hard
  when: eic_stat.stat.exists
  notify: 
    - stop ssh service
    - daemon reload

