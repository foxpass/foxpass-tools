---
# shared tasks

- name: write foxpass_ssh_keys.sh 
  template: 
    src: foxpass_ssh_keys.sh.j2
    dest: /usr/local/sbin/foxpass_ssh_key.sh

- name: check sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '#auto-generated by Foxpass'
    state: absent 
  check_mode: yes
  changed_when: False
  register: ssh_config_regex

- name: augment sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "#auto-generated by Foxpass\nAuthorizedKeysCommand\t\t/usr/local/sbin/foxpass_ssh_keys.sh\nAuthorizedKeysCommandUser\troot\n"
  when: not ssh_config_regex.found
  notify: restart ssh

- name: check sudoers
  lineinfile:
    path: /etc/sudoers
    line: "#auto-generated by Foxpass"
    state: absent 
  check_mode: yes
  changed_when: False
  register: sudoers_regex

- name: augment /etc/sudoers
  lineinfile:
    path: /etc/sudoers
    line: "#auto-generated by Foxpass\n#includedir /etc/sudoers.d\n"
  when: not sudoers_regex.found


- name: create sudoers.d directory
  file:
    path: /etc/sudoers.d
    state: directory
    mode: '0750'

